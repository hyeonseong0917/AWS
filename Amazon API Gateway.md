## Amazon API Gateway 소개



### 개요

간단한 FAQ 마이크로 서비스를 생성

마이크로 서비스는 Lambda함수를 호출하는 Amazon API Gateway 엔드포인트를 이용해 임의의 질문과 답변 쌍이 포함된 json 객체 변환

마이크로 서비스의 아키텍처 패턴



이 실습이 끝나면 다음을 수행할 수 있습니다.

- AWS Lambda 함수 생성
- Amazon API Gateway 엔드 포인트 생성
- Amazon CloudWatch로 API Gateway 및  Lambda 디버그



### 기술 개념

1.마이크로 서비스 아키텍처

- 단일 애플리케이션을 소규모 서비스 모음으로 개발하기 위한 접근 방식
- 크고 복잡한 시스템을 관리하고 확장하기 쉬운 독립적인 분리된 서비스로 나누는 것



2.API(응용프로그램 인터페이스)

- 애플리케이션에서 제공하는 다양한 서비스를 인터페이스하는 표준화된 접근방식을 만드는 것



3.RESTful API

- 클라이언트-서버 모델
- 클라이언트는 네트워크 효율 향상을 위해 데이터를 캐시
- 서버와 클라이언트 사이에 균일한 인터페이스(API 형식)이 존재
- 레이어 개념 도입
- 온디맨드 코드 패턴-클라이언트 업데이트 없이 코드를 변경가능



클라이언트:백엔드 Lambda함수(서버)에 요청

서비스 로직:Lambda함수 내에 캡슐화, 클라이언트가 사용할 수 있는 균일한 인터페이스 제공



### Amazon API Gateway 및 AWS Lambda

API Gateway를 사용하는 마이크로 서비스는  API 게이트웨이 및 백엔드 대상에 정의된 메소드로 구성

이 실습에서 백엔드 대상은 Lambda



### Amazon API Gateway

API를 쉽게 생성, 배포, 유지 관리할 수 있는 관리형 서비스

- 백엔드 시스템과 일치하도록 수신 API 요청의 본문과 헤더를 변환
- API 요구사항에 맞게 API응답의 본문과 헤더를 변환
- IAM을 통한 API 액세스 제어
- 타사 개발을 위한 API 키 생성 및 적용
- API 모니터링을 위한 CloudWatch 통합 활성화
- 더 빠른 응답 시간을 위해 CloudFront를 통해 API 응답 캐시
- API에 사용자 지정 도메인 연결
- API 요청 및 응답 변환을 표준화하는데 도움이 되는 모델 정의



### Amazon API Gateway 및 AWS Lambda 용어

- Resource 

  1.URL엔드포인트와 경로로 표시 (api.mysite.com/questions)

  2.HTTP 메소드를 리소스와 연결하고 각 메소드에 대해 서로 다른 백엔드 대상을 정의할 수 있음

- Method

  1.리소스 경로와 GET,POST,DELETE와 같은 HTTP 동사의 조합으로 식별

- Method Request

  1.메서드 권한 부여 설정 저장 및 클라이언트에서 수신한 URL 쿼리 문자열 매개변수 및 HTTP 요청 헤더 정의

- Integration Request

  1.메소드와 함께 사용되는 백엔드 대상을 정의

  2.매핑 템플릿 정의 가능

- Method Response

  1.메소드 응답 유형, 헤더 및 콘텐츠 유형 정의

- Model

  1.모델은 일부 데이터의 형식

  2.모델을 만들고 사용하여 매핑 템플릿을 더 쉽게 제작 가능

  3.JSON 스키마를 이용하여 데이터의 예상 스키마 제작

- Stage

  1.API 배포에 액세스할 수 있는 경로를 정의

- BluePrint

  1.Lambda 함수를 구축하기 위한 기반으로 사용할 수 있는 예제 Lambda함수



## 작업 1 : Lambda 함수 생성

1 . Lambda function 생성

- Function name : FAQ
- Runtime : Node.js 12.x
- Expand Change default execution role
- Execution role : Use an existing role



2 . Code tab에서 index.js 수정

- var json = {  "service": "lambda",  "reference": "https://aws.amazon.com/lambda/faqs/",  "questions": [{    "q": "What is AWS Lambda?",    "a": "AWS Lambda lets you run code without provisioning or managing servers. You pay only for the compute time you consume - there is no charge when your code is not running. With Lambda, you can run code for virtually any type of application or backend service - all with zero administration. Just upload your code and Lambda takes care of everything required to run and scale your code with high availability. You can set up your code to automatically trigger from other AWS services or call it directly from any web or mobile app."  },{   "q":"What events can trigger an AWS Lambda function?",   "a":"You can use AWS Lambda to respond to table updates in Amazon DynamoDB, modifications to objects in Amazon S3 buckets, logs arriving in Amazon CloudWatch logs, incoming emails to Amazon Simple Email Service, notifications sent from Amazon SNS, messages arriving in an Amazon Kinesis stream, client data synchronization events in Amazon Cognito, and custom events from mobile applications, web applications, or other web services. You can also invoke a Lambda function on a defined schedule using the AWS Lambda console."  },{   "q":"When should I use AWS Lambda versus Amazon EC2?",   "a":"Amazon Web Services offers a set of compute services to meet a range of needs. Amazon EC2 offers flexibility, with a wide range of instance types and the option to customize the operating system, network and security settings, and the entire software stack, allowing you to easily move existing applications to the cloud. With Amazon EC2 you are responsible for provisioning capacity, monitoring fleet health and performance, and designing for fault tolerance and scalability. AWS Elastic Beanstalk offers an easy-to-use service for deploying and scaling web applications in which you retain ownership and full control over the underlying EC2 instances. Amazon Elastic Container Service is a scalable management service that supports Docker containers and allows you to easily run distributed applications on a managed cluster of Amazon EC2 instances. AWS Lambda makes it easy to execute code in response to events, such as changes to Amazon S3 buckets, updates to an Amazon DynamoDB table, or custom events generated by your applications or devices. With Lambda you do not have to provision your own instances; Lambda performs all the operational and administrative activities on your behalf, including capacity provisioning, monitoring fleet health, applying security patches to the underlying compute resources, deploying your code, running a web service front end, and monitoring and logging your code. AWS Lambda provides easy scaling and high availability to your code without additional effort on your part."  },{    "q":"What kind of code can run on AWS Lambda?",    "a":"AWS Lambda offers an easy way to accomplish many activities in the cloud. For example, you can use AWS Lambda to build mobile back-ends that retrieve and transform data from Amazon DynamoDB, handlers that compress or transform objects as they are uploaded to Amazon S3, auditing and reporting of API calls made to any Amazon Web Service, and server-less processing of streaming data using Amazon Kinesis."  },{    "q":"What languages does AWS Lambda support?",    "a":"AWS Lambda supports code written in Node.js (JavaScript), Python, and Java (Java 8 compatible). Your code can include existing libraries, even native ones. Lambda functions can easily launch processes using languages supported by Amazon Linux, including Bash, Go, and Ruby. Please read our documentation on using Node.js, Python and Java."  },{    "q":"Can I access the infrastructure that AWS Lambda runs on?",    "a":"No. AWS Lambda operates the compute infrastructure on your behalf, allowing it to perform health checks, apply security patches, and do other routine maintenance."  },{    "q":"How does AWS Lambda isolate my code?",    "a":"Each AWS Lambda function runs in its own isolated environment, with its own resources and file system view. AWS Lambda uses the same techniques as Amazon EC2 to provide security and separation at the infrastructure and execution levels."  },{    "q":"How does AWS Lambda secure my code?",    "a":"AWS Lambda stores code in Amazon S3 and encrypts it at rest. AWS Lambda performs additional integrity checks while your code is in use."  },{    "q":"What is an AWS Lambda function?",    "a":"The code you run on AWS Lambda is uploaded as a Lambda function. Each function has associated configuration information, such as its name, description, entry point, and resource requirements. The code must be written in a stateless style i.e. it should assume there is no affinity to the underlying compute infrastructure. Local file system access, child processes, and similar artifacts may not extend beyond the lifetime of the request, and any persistent state should be stored in Amazon S3, Amazon DynamoDB, or another Internet-available storage service. Lambda functions can include libraries, even native ones."  },{    "q":"Will AWS Lambda reuse function instances?",    "a":"To improve performance, AWS Lambda may choose to retain an instance of your function and reuse it to serve a subsequent request, rather than creating a new copy. Your code should not assume that this will always happen."  },{    "q":"What if I need scratch space on disk for my AWS Lambda function?",    "a":"Each Lambda function receives 500MB of non-persistent disk space in its own /tmp directory."  },{    "q":"Why must AWS Lambda functions be stateless?",    "a":"Keeping functions stateless enables AWS Lambda to rapidly launch as many copies of the function as needed to scale to the rate of incoming events. While AWS Lambda's programming model is stateless, your code can access stateful data by calling other web services, such as Amazon S3 or Amazon DynamoDB."  },{    "q":"Can I use threads and processes in my AWS Lambda function code?",    "a":"Yes. AWS Lambda allows you to use normal language and operating system features, such as creating additional threads and processes. Resources allocated to the Lambda function, including memory, execution time, disk, and network use, must be shared among all the threads/processes it uses. You can launch processes using any language supported by Amazon Linux."  },{    "q":"What restrictions apply to AWS Lambda function code?",    "a":"Lambda attempts to impose few restrictions on normal language and operating system activities, but there are a few activities that are disabled: Inbound network connections are managed by AWS Lambda, only TCP/IP sockets are supported, and ptrace (debugging) system calls are restricted. TCP port 25 traffic is also restricted as an anti-spam measure."  },{    "q":"How do I create an AWS Lambda function using the Lambda console?",    "a":"You can author the code for your function using the inline editor in the AWS Lambda console. You can also package the code (and any dependent libraries) as a ZIP and upload it using the AWS Lambda console from your local environment or specify an Amazon S3 location where the ZIP file is located. Uploads must be no larger than 50MB (compressed). You can use the AWS Eclipse plugin to author and deploy Lambda functions in Java and Node.js. If you are using Node.js, you can author the code for your function using the inline editor in the AWS Lambda console. Go to the console to get started."  },{    "q":"How do I create an AWS Lambda function using the Lambda CLI?",    "a":"You can package the code (and any dependent libraries) as a ZIP and upload it using the AWS CLI from your local environment, or specify an Amazon S3 location where the ZIP file is located. Uploads must be no larger than 50MB (compressed). Visit the Lambda Getting Started guide to get started."  },{    "q":"Which versions of Python are supported?",    "a":"Lambda provides a Python 2.7-compatible runtime to execute your Lambda functions. Lambda will include the latest AWS SDK for Python (boto3) by default."  },{    "q":"How do I compile my AWS Lambda function Java code?",    "a":"You can use standard tools like Maven or Gradle to compile your Lambda function. Your build process should mimic the same build process you would use to compile any Java code that depends on the AWS SDK. Run your Java compiler tool on your source files and include the AWS SDK 1.9 or later with transitive dependencies on your classpath. For more details, see our documentation."  },{    "q":"What is the JVM environment Lambda uses for execution of my function?",    "a":"Lambda provides the Amazon Linux build of openjdk 1.8."  }  ] } exports.handler = function(event, context) {    var rand = Math.floor(Math.random() * json.questions.length);    console.log("Quote selected: ", rand);     var response = {        body: JSON.stringify(json.questions[rand])    };    console.log(response);    context.succeed(response); };
- FAQ 리스트 정의
- Random FAQ 반환

3 . Add trigger

- Select Trigger : API Gateway
- API : Create an API
- API type : Rest API
- Security : Open
- Expand : Additional settings
- API name : FAQ - API
- Deployment Stage : myDeployment



## Task 2 : Test the Lambda function

- copy API endpoint , paste browser tab
- should see a random FAQ entry
- Lambda function can also be tested in isolation





## Conclusion

- Create an AWS Lambda function

- Create an Amazon API Gateway endpoints

  















